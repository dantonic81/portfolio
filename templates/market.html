{% extends 'base.html' %}

{% block title %}Crypto Market Overview{% endblock %}

{% block content %}

<div class="container mt-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="display-5">Crypto Market Overview</h1>
    <input type="text" id="search-bar" class="form-control w-25" placeholder="Search by name or symbol...">
  </div>

  <!-- Table Section -->
  <div class="table-container">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Name</th>
          <th>Symbol</th>
          <th>Current Price</th>
          <th>Market Cap</th>
          <th>Market Cap Rank</th>
          <th>Fully Diluted Valuation</th>
          <th>Volume (24h)</th>
          <th>High 24h</th>
          <th>Low 24h</th>
          <th>Price Change (24h)</th>
          <th>Price Change Percentage (24h)</th>
          <th>Market Cap Change 24h</th>
          <th>Market Cap Change Percentage 24h</th>
          <th>Circulating Supply</th>
          <th>Total Supply</th>
          <th>Max Supply</th>
          <th>ATH</th>
          <th>ATH Change Percentage</th>
          <th>ATH Date</th>
          <th>ATL</th>
          <th>ATL Change Percentage</th>
          <th>ATL Date</th>
          <th>Last Updated</th>
        </tr>
      </thead>
      <tbody>
        {% for coin in coins %}
        <tr>
          <td>{{ coin.market_cap_rank }}</td>
          <td>
            <img src="{{ coin.image }}" alt="{{ coin.name }}" style="width: 24px; height: 24px;" class="mr-2">
            {{ coin.name }}
          </td>
          <td>{{ coin.symbol | upper }}</td>
          <td>${{ coin.current_price | round(2) }}</td>
          <td>${{ coin.market_cap | round(2) }}</td>
          <td>{{ coin.market_cap_rank }}</td>
          <td>${{ coin.fully_diluted_valuation | round(2) }}</td>
          <td>${{ coin.total_volume | round(2) }}</td>
          <td>${{ coin.high_24h | round(2) }}</td>
          <td>${{ coin.low_24h | round(2) }}</td>
          <td>${{ coin.price_change_24h | round(2) }}</td>
          <td class="{{ 'text-success' if coin.price_change_percentage_24h > 0 else 'text-danger' }}">
            {{ coin.price_change_percentage_24h | round(2) }}%
          </td>
          <td>${{ coin.market_cap_change_24h | round(2) }}</td>
          <td class="{{ 'text-success' if coin.market_cap_change_percentage_24h > 0 else 'text-danger' }}">
            ${{ coin.market_cap_change_percentage_24h | round(2) }}%</td>
          <td>{{ coin.circulating_supply | round(2) }}</td>
          <td>{{ coin.total_supply | round(2) if coin.total_supply else 'N/A' }}</td>
          <td>{{ coin.max_supply | round(2) }}</td>
          <td>${{ coin.ath | round(2) }}</td>
          <td class="{{ 'text-success' if coin.ath_change_percentage > 0 else 'text-danger' }}">
            ${{ coin.ath_change_percentage | round(2) }}%</td>
          <td>{{ coin.ath_date }}</td>
          <td>${{ coin.atl | round(2) }}</td>
          <td class="{{ 'text-success' if coin.atl_change_percentage > 0 else 'text-danger' }}">
            ${{ coin.atl_change_percentage | round(2) }}%</td>
          <td>{{ coin.atl_date }}</td>
          <td>{{ coin.last_updated }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const tableContainer = document.querySelector('.table-container');
  const totalParts = 10; // Split the container into 10 parts (left and right zones)
  const scrollSpeed = 10;  // Speed of scrolling (adjust as needed)

  tableContainer.addEventListener('mousemove', (e) => {
    const containerWidth = tableContainer.offsetWidth; // Container width
    const tableWidth = tableContainer.scrollWidth; // Total table width (for scrolling)
    const hoverPosition = e.clientX - tableContainer.getBoundingClientRect().left; // Mouse position relative to the container

    // Calculate relative width for each section (each section is 1/10 of visible width)
    const partWidth = containerWidth / totalParts;

    // Define the left and right threshold within the container's visible area
    const leftThreshold = partWidth;
    const rightThreshold = containerWidth - partWidth;

    // Check if we're in the left zone (relative to visible area) and scroll left
    if (hoverPosition < leftThreshold && tableContainer.scrollLeft > 0) {
      tableContainer.scrollLeft -= scrollSpeed; // Scroll left
    }
    // Check if we're in the right zone (relative to visible area) and scroll right
    else if (hoverPosition > rightThreshold && tableContainer.scrollLeft < tableWidth - containerWidth) {
      tableContainer.scrollLeft += scrollSpeed; // Scroll right
    }
  });

  // Debounce function to limit the rate of filtering
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Cache table rows and their data for faster filtering
  const rows = Array.from(document.querySelectorAll('tbody tr'));
  const rowData = rows.map(row => ({
    element: row,
    name: row.children[1].innerText.toLowerCase(),
    symbol: row.children[2].innerText.toLowerCase(),
  }));

  // Filter functionality
  function filterTable(searchTerm) {
    rowData.forEach(({ element, name, symbol }) => {
      element.style.display = name.includes(searchTerm) || symbol.includes(searchTerm) ? '' : 'none';
    });
  }

  // Attach debounced event listener to the search bar
  document.getElementById('search-bar').addEventListener('input', debounce(function(e) {
    const searchTerm = e.target.value.toLowerCase();
    filterTable(searchTerm);
  }, 200)); // Adjust debounce delay as needed
</script>


{% endblock %}
